<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Табулированные функции</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 24px; background: #f5f7fa; }
        h1 { margin-bottom: 8px; }
        .card { background: #fff; padding: 16px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin-bottom: 24px; }
        .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        label { font-weight: bold; }
        input, select { padding: 8px; border-radius: 8px; border: 1px solid #d2d8e0; min-width: 80px; }
        button { padding: 10px 16px; border: none; border-radius: 8px; background: #3f51b5; color: #fff; cursor: pointer; }
        button.secondary { background: #607d8b; }
        table { width: 100%; border-collapse: collapse; margin-top: 12px; }
        th, td { border: 1px solid #e0e0e0; padding: 8px; text-align: left; }
        th { background: #fafafa; }
        .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.45); display: none; align-items: center; justify-content: center; }
        .modal { background: #fff; padding: 20px; border-radius: 12px; max-width: 440px; width: 90%; }
        .flex-end { display: flex; justify-content: flex-end; margin-top: 12px; }
        .hint { color: #607d8b; font-size: 12px; }
    </style>
</head>
<body>
<h1>Создание табулированных функций</h1>
<p class="hint">Интерфейс не допускает вывод ошибок в консоль: все проблемы показываются в модальном окне.</p>
<div class="card" id="array-card">
    <h2>Создание из массивов X и Y</h2>
    <div class="row">
        <label for="array-count">Количество точек</label>
        <input id="array-count" type="number" min="2" max="500" placeholder="Например, 4">
        <button id="array-generate">Построить таблицу</button>
    </div>
    <div class="hint">Повторное нажатие очищает введённые значения и создаёт новую таблицу. Максимум 500 строк.</div>
    <div id="array-table-wrapper"></div>
    <div class="flex-end"><button id="array-submit" class="secondary">Создать</button></div>
</div>

<div class="card" id="math-card">
    <h2>Создание из математической функции</h2>
    <div class="row">
        <label for="math-function">Функция</label>
        <select id="math-function"></select>
        <label for="math-from">От</label>
        <input id="math-from" type="number" step="0.1" placeholder="0">
        <label for="math-to">До</label>
        <input id="math-to" type="number" step="0.1" placeholder="10">
        <label for="math-count">Количество точек</label>
        <input id="math-count" type="number" min="2" max="500" value="5">
        <button id="math-submit">Создать</button>
    </div>
</div>

<div class="modal-backdrop" id="modal">
    <div class="modal">
        <h3>Ошибка</h3>
        <p id="modal-text"></p>
        <div class="flex-end"><button id="modal-close">Закрыть</button></div>
    </div>
</div>

<script>
    const modal = document.getElementById('modal');
    const modalText = document.getElementById('modal-text');
    document.getElementById('modal-close').addEventListener('click', () => modal.style.display = 'none');

    function showError(message) {
        modalText.textContent = message || 'Неизвестная ошибка';
        modal.style.display = 'flex';
    }

    async function loadFunctions() {
        const response = await fetch('/ui/api/functions');
        if (!response.ok) {
            showError('Не удалось загрузить список функций');
            return;
        }
        const select = document.getElementById('math-function');
        select.innerHTML = '';
        const names = await response.json();
        names.forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            select.appendChild(option);
        });
    }

    function renderTable(count) {
        const wrapper = document.getElementById('array-table-wrapper');
        wrapper.innerHTML = '';
        const table = document.createElement('table');
        const head = document.createElement('tr');
        head.innerHTML = '<th>X</th><th>Y</th>';
        table.appendChild(head);
        for (let i = 0; i < count; i++) {
            const row = document.createElement('tr');
            const xCell = document.createElement('td');
            const yCell = document.createElement('td');
            xCell.innerHTML = `<input type="number" step="0.1" class="x-input" data-index="${i}" placeholder="X${i+1}">`;
            yCell.innerHTML = `<input type="number" step="0.1" class="y-input" data-index="${i}" placeholder="Y${i+1}">`;
            row.appendChild(xCell);
            row.appendChild(yCell);
            table.appendChild(row);
        }
        wrapper.appendChild(table);
    }

    document.getElementById('array-generate').addEventListener('click', () => {
        const count = Number(document.getElementById('array-count').value);
        if (!Number.isInteger(count) || count < 2) {
            showError('Введите целое число точек не меньше 2');
            return;
        }
        if (count > 500) {
            showError('Максимальное количество точек — 500');
            return;
        }
        renderTable(count);
    });

    document.getElementById('array-submit').addEventListener('click', async () => {
        const xInputs = Array.from(document.querySelectorAll('.x-input'));
        const yInputs = Array.from(document.querySelectorAll('.y-input'));
        if (xInputs.length === 0) {
            showError('Сначала создайте таблицу точек');
            return;
        }
        try {
            const xValues = xInputs.map(input => parseFloat(input.value));
            const yValues = yInputs.map(input => parseFloat(input.value));
            if (xValues.some(v => Number.isNaN(v)) || yValues.some(v => Number.isNaN(v))) {
                throw new Error('Заполните все значения X и Y');
            }
            const response = await fetch('/ui/api/tabulated/array', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ xValues, yValues })
            });
            if (!response.ok) {
                const error = await response.json();
                showError(error.message);
                return;
            }
            document.getElementById('array-table-wrapper').innerHTML = '';
            document.getElementById('array-count').value = '';
        } catch (e) {
            showError(e.message);
        }
    });

    document.getElementById('math-submit').addEventListener('click', async () => {
        try {
            const functionName = document.getElementById('math-function').value;
            const from = document.getElementById('math-from').value;
            const to = document.getElementById('math-to').value;
            const count = Number(document.getElementById('math-count').value);
            const response = await fetch('/ui/api/tabulated/math', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ functionName, from, to, count })
            });
            if (!response.ok) {
                const error = await response.json();
                showError(error.message);
                return;
            }
        } catch (e) {
            showError(e.message);
        }
    });

    loadFunctions();
</script>
</body>
</html>
