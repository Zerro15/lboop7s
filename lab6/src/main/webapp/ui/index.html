<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Табулированные функции</title>
    <style>
        :root {
            --bg: #f5f7fb;
            --card: #ffffff;
            --primary: #2d6cdf;
            --primary-dark: #1f4ea3;
            --muted: #5f6b7c;
            --border: #dfe3ea;
            --danger: #e74c3c;
            --success: #00a884;
        }
        body.dark {
            --bg: #0f172a;
            --card: #111827;
            --primary: #7c3aed;
            --primary-dark: #5b21b6;
            --muted: #cbd5e1;
            --border: #1f2937;
            --danger: #ef4444;
            --success: #10b981;
            color: #e2e8f0;
        }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: "Inter", Arial, sans-serif; background: var(--bg); color: #1f2d3d; transition: background .2s ease, color .2s ease; }
        header { padding: 20px 24px; background: var(--card); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap; }
        header h1 { margin: 0 0 4px; }
        header p { margin: 0; color: var(--muted); }
        main { padding: 24px; display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.04); }
        .card h2 { margin-top: 0; margin-bottom: 6px; }
        .card p { color: var(--muted); margin-top: 0; }
        button { background: var(--primary); border: none; color: #fff; padding: 10px 16px; border-radius: 10px; cursor: pointer; font-weight: 600; transition: background 0.2s ease; }
        button:hover { background: var(--primary-dark); }
        button.secondary { background: #ecf1f9; color: #1f2d3d; border: 1px solid var(--border); }
        body.dark button.secondary { background: #1f2937; color: #e2e8f0; }
        button.secondary:hover { background: #e1e8f3; }
        button.danger { background: var(--danger); }
        .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .hint { color: var(--muted); font-size: 13px; margin-top: 4px; }
        .table-wrapper { border: 1px solid var(--border); border-radius: 10px; overflow: hidden; background: var(--card); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px 10px; border-bottom: 1px solid var(--border); }
        th { background: #f1f4fa; text-align: left; font-weight: 600; font-size: 14px; }
        body.dark th { background: #111827; }
        td input { width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 8px; background: transparent; color: inherit; }
        .actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
        .modal-backdrop { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.55); display: none; align-items: center; justify-content: center; padding: 16px; z-index: 10; }
        .modal { background: var(--card); border-radius: 16px; width: min(1100px, 95vw); max-height: 90vh; overflow: auto; padding: 20px; box-shadow: 0 18px 40px rgba(0,0,0,0.16); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; gap: 12px; }
        .modal-header h3 { margin: 0; }
        .close-btn { background: transparent; border: none; font-size: 20px; color: var(--muted); cursor: pointer; }
        label { font-weight: 600; color: #1f2d3d; }
        body.dark label { color: #e2e8f0; }
        input, select { padding: 10px 12px; border: 1px solid var(--border); border-radius: 10px; background: #fff; }
        body.dark input, body.dark select { background: #0b1220; color: #e2e8f0; }
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; }
        .auth-fields { display: flex; flex-direction: column; gap: 8px; }
        .auth-fields label { margin-bottom: -4px; }
        .divider { height: 1px; background: var(--border); margin: 14px 0; }
        .badge { padding: 4px 8px; border-radius: 12px; background: #ecf1f9; color: var(--primary-dark); font-size: 12px; font-weight: 700; }
        body.dark .badge { background: #1f2937; color: #c084fc; }
        canvas { background: var(--card); border-radius: 12px; border: 1px solid var(--border); padding: 12px; }
    </style>
</head>
<body>
<header>
    <div>
        <h1>Работа с табулированными функциями</h1>
        <p>Главное окно: открывайте настройки, графики, операции без дублирования окон</p>
    </div>
    <div class="row">
        <div id="user-chip" class="badge">Гость</div>
        <button id="toggle-theme" class="secondary">Темная тема</button>
    </div>
</header>
<main>
    <div class="card">
        <h2>Настройки</h2>
        <p>Выбор фабрики табулированных функций (по умолчанию — массив)</p>
        <button id="open-settings">Открыть настройки</button>
    </div>
    <div class="card">
        <h2>Операции</h2>
        <p>Сложение, вычитание, умножение и деление двух функций</p>
        <button id="open-operations">Открыть окно операций</button>
    </div>
    <div class="card">
        <h2>Дифференцирование</h2>
        <p>Получение производной табулированной функции</p>
        <button id="open-derivative">Открыть окно дифференцирования</button>
    </div>
    <div class="card">
        <h2>График функции</h2>
        <p>Изучайте табулированную функцию, редактируйте точки и смотрите график</p>
        <button id="open-graph">Открыть графическое окно</button>
    </div>
    <div class="card">
        <h2>Интеграл</h2>
        <p>Параллельное вычисление определённого интеграла</p>
        <button id="open-integral">Открыть окно интеграла</button>
    </div>
    <div class="card">
        <h2>Составные функции</h2>
        <p>Комбинируйте простые функции и используйте их для табуляции</p>
        <button id="open-composite">Открыть конструктор функций</button>
    </div>
</main>

<div class="modal-backdrop" id="backdrop">
    <!-- Settings -->
    <div class="modal" id="settings-modal">
        <div class="modal-header"><h3>Настройки фабрики</h3><button class="close-btn" data-close>&times;</button></div>
        <div class="divider"></div>
        <div class="grid-2">
            <label for="factory-select">Текущая фабрика</label>
            <select id="factory-select">
                <option value="ARRAY">Массив</option>
                <option value="LIST">Связный список</option>
            </select>
        </div>
        <div class="actions" style="margin-top:14px; justify-content: space-between;">
            <div class="row">
                <label for="save-format">Формат сохранения:</label>
                <select id="save-format">
                    <option value="bin">Бинарный</option>
                    <option value="json">JSON</option>
                    <option value="xml">XML</option>
                </select>
            </div>
            <div>
                <button class="secondary" data-close>Отмена</button>
                <button id="save-factory">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Operations -->
    <div class="modal" id="operations-modal">
        <div class="modal-header"><h3>Базовые операции</h3><button class="close-btn" data-close>&times;</button></div>
        <p class="hint">Создавайте функции из массивов или из другой функции, загружайте/сохраняйте, редактируйте Y. Кнопки вставки/удаления доступны для Insertable/Removable.</p>
        <div class="grid-2">
            <div>
                <h4>Первый операнд</h4>
                <div id="table-a" class="table-wrapper"></div>
                <div class="actions">
                    <button data-create-array="opA">Из массивов</button>
                    <button data-create-math="opA" class="secondary">Из функции</button>
                    <button data-insert="opA" class="secondary">Вставка</button>
                    <button data-remove="opA" class="secondary">Удалить</button>
                </div>
                <div class="actions">
                    <button data-load="opA" class="secondary">Загрузить</button>
                    <button data-save="opA" class="secondary">Сохранить</button>
                </div>
            </div>
            <div>
                <h4>Второй операнд</h4>
                <div id="table-b" class="table-wrapper"></div>
                <div class="actions">
                    <button data-create-array="opB">Из массивов</button>
                    <button data-create-math="opB" class="secondary">Из функции</button>
                    <button data-insert="opB" class="secondary">Вставка</button>
                    <button data-remove="opB" class="secondary">Удалить</button>
                </div>
                <div class="actions">
                    <button data-load="opB" class="secondary">Загрузить</button>
                    <button data-save="opB" class="secondary">Сохранить</button>
                </div>
            </div>
        </div>
        <div class="divider"></div>
        <h4>Результат</h4>
        <div id="table-result" class="table-wrapper"></div>
        <div class="actions">
            <button data-operation="add">Сложение</button>
            <button data-operation="subtract" class="secondary">Вычитание</button>
            <button data-operation="multiply" class="secondary">Умножение</button>
            <button data-operation="divide" class="secondary">Деление</button>
            <button data-save="result" class="secondary">Сохранить результат</button>
        </div>
    </div>

    <!-- Derivative -->
    <div class="modal" id="derivative-modal">
        <div class="modal-header"><h3>Дифференцирование функции</h3><button class="close-btn" data-close>&times;</button></div>
        <p class="hint">Левая таблица редактируется (Insertable/Removable), правая — результат вычисления производной.</p>
        <div class="grid-2">
            <div>
                <h4>Исходная функция</h4>
                <div id="table-derivative-src" class="table-wrapper"></div>
                <div class="actions">
                    <button data-create-array="diffSource">Из массивов</button>
                    <button data-create-math="diffSource" class="secondary">Из функции</button>
                    <button data-insert="diffSource" class="secondary">Вставка</button>
                    <button data-remove="diffSource" class="secondary">Удалить</button>
                </div>
                <div class="actions">
                    <button data-load="diffSource" class="secondary">Загрузить</button>
                    <button data-save="diffSource" class="secondary">Сохранить</button>
                </div>
            </div>
            <div>
                <h4>Производная</h4>
                <div id="table-derivative-res" class="table-wrapper"></div>
                <div class="actions">
                    <button id="run-derivative">Вычислить производную</button>
                    <button data-save="diffResult" class="secondary">Сохранить результат</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Graph modal -->
    <div class="modal" id="graph-modal">
        <div class="modal-header"><h3>График табулированной функции</h3><button class="close-btn" data-close>&times;</button></div>
        <div class="grid-2">
            <div>
                <div id="table-graph" class="table-wrapper"></div>
                <div class="actions">
                    <button data-create-array="graph">Из массивов</button>
                    <button data-create-math="graph" class="secondary">Из функции</button>
                    <button data-insert="graph" class="secondary">Вставка</button>
                    <button data-remove="graph" class="secondary">Удалить</button>
                </div>
                <div class="actions">
                    <button data-load="graph" class="secondary">Загрузить</button>
                    <button data-save="graph" class="secondary">Сохранить</button>
                </div>
                <div class="actions">
                    <input id="graph-name" placeholder="Название функции">
                    <button id="graph-save">Сохранить график</button>
                </div>
                <div class="actions">
                    <select id="graph-saved"></select>
                    <button id="graph-load" class="secondary">Загрузить сохранённый</button>
                </div>
                <div class="actions">
                    <input id="apply-x" type="number" step="0.1" placeholder="X для вычисления">
                    <button id="apply-run">Вычислить apply()</button>
                    <span id="apply-result" class="badge">—</span>
                </div>
            </div>
            <div>
                <canvas id="graph-canvas" height="320"></canvas>
            </div>
        </div>
    </div>

    <!-- Integral modal -->
    <div class="modal" id="integral-modal">
        <div class="modal-header"><h3>Определённый интеграл</h3><button class="close-btn" data-close>&times;</button></div>
        <div class="grid-2">
            <div>
                <div id="table-integral" class="table-wrapper"></div>
                <div class="actions">
                    <button data-create-array="integral">Из массивов</button>
                    <button data-create-math="integral" class="secondary">Из функции</button>
                    <button data-insert="integral" class="secondary">Вставка</button>
                    <button data-remove="integral" class="secondary">Удалить</button>
                </div>
                <div class="actions">
                    <button data-load="integral" class="secondary">Загрузить</button>
                    <button data-save="integral" class="secondary">Сохранить</button>
                </div>
            </div>
            <div>
                <div class="row">
                    <label for="integral-threads">Количество потоков</label>
                    <input id="integral-threads" type="number" min="1" max="16" value="2">
                    <button id="integral-run">Вычислить интеграл</button>
                </div>
                <div class="hint">Значение:</div>
                <div class="badge" id="integral-result">—</div>
            </div>
        </div>
    </div>

    <!-- Composite modal -->
    <div class="modal" id="composite-modal">
        <div class="modal-header"><h3>Составная функция</h3><button class="close-btn" data-close>&times;</button></div>
        <div class="grid-2" style="margin-top:12px;">
            <label for="composite-name">Локализованное имя</label>
            <input id="composite-name" placeholder="Например, Квадрат синуса">
            <label for="composite-priority">Приоритет отображения</label>
            <input id="composite-priority" type="number" value="5">
        </div>
        <div class="divider"></div>
        <p class="hint">Выберите функции (применяются справа налево, как композиция).</p>
        <div id="composite-list" style="max-height:220px; overflow:auto; border:1px solid var(--border); border-radius:12px; padding:8px;"></div>
        <div class="actions" style="justify-content: flex-end;">
            <button class="secondary" data-close>Отмена</button>
            <button id="composite-save">Создать и добавить в список</button>
        </div>
    </div>

    <!-- Create from arrays -->
    <div class="modal" id="create-array-modal">
        <div class="modal-header"><h3>Создание функции из массивов</h3><button class="close-btn" data-close>&times;</button></div>
        <div class="row" style="margin: 10px 0;">
            <label for="array-count">Количество точек</label>
            <input id="array-count" type="number" min="2" max="500" placeholder="Например, 5">
            <button id="array-generate">Построить таблицу</button>
        </div>
        <div class="hint">Повторное нажатие сбрасывает данные. Максимум 500 точек.</div>
        <div id="array-table-wrapper" class="table-wrapper" style="margin-top:10px;"></div>
        <div class="actions" style="justify-content: flex-end;">
            <button class="secondary" data-close>Отмена</button>
            <button id="array-submit">Создать</button>
        </div>
    </div>

    <!-- Create from math function -->
    <div class="modal" id="create-math-modal">
        <div class="modal-header"><h3>Создание из другой функции</h3><button class="close-btn" data-close>&times;</button></div>
        <div class="grid-2" style="margin-top:10px;">
            <label for="math-function">Функция</label>
            <select id="math-function"></select>
            <label for="math-from">От</label>
            <input id="math-from" type="number" step="0.1" placeholder="0">
            <label for="math-to">До</label>
            <input id="math-to" type="number" step="0.1" placeholder="10">
            <label for="math-count">Количество точек</label>
            <input id="math-count" type="number" min="2" max="500" value="5">
        </div>
        <div class="actions" style="justify-content: flex-end; margin-top:14px;">
            <button class="secondary" data-close>Отмена</button>
            <button id="math-submit">Создать</button>
        </div>
    </div>

    <!-- Auth modal -->
    <div class="modal" id="auth-modal">
        <div class="modal-header"><h3 id="auth-title">Вход</h3></div>
        <div class="auth-fields" style="margin-top:10px;">
            <label for="auth-login">Логин</label>
            <input id="auth-login" placeholder="login">
            <label for="auth-password">Пароль</label>
            <input id="auth-password" type="password" placeholder="Пароль">
        </div>
        <div class="actions" style="justify-content: space-between; margin-top:14px;">
            <button id="auth-switch" class="secondary">Переключить вход/регистрацию</button>
            <button id="auth-submit">Продолжить</button>
        </div>
    </div>

    <!-- Error modal -->
    <div class="modal" id="error-modal">
        <div class="modal-header"><h3>Ошибка</h3><button class="close-btn" data-close>&times;</button></div>
        <p id="error-message"></p>
        <div class="actions" style="justify-content: flex-end;">
            <button data-close>Закрыть</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
    const apiBase = (() => {
        const marker = '/ui/';
        const idx = window.location.pathname.indexOf(marker);
        const prefix = idx >= 0 ? window.location.pathname.substring(0, idx) : '';
        return `${prefix}/ui/api`;
    })();

    const state = {
        token: localStorage.getItem('token'),
        login: localStorage.getItem('login'),
        role: localStorage.getItem('role'),
        authMode: 'login',
        factory: 'ARRAY',
        functionsList: [],
        savedFunctions: [],
        saveFormat: 'bin',
        functions: {
            opA: { points: [], insertable: true, removable: true },
            opB: { points: [], insertable: true, removable: true },
            result: { points: [], insertable: false, removable: false },
            diffSource: { points: [], insertable: true, removable: true },
            diffResult: { points: [], insertable: false, removable: false },
            graph: { points: [], insertable: true, removable: true },
            integral: { points: [], insertable: true, removable: true }
        },
        creationTarget: null,
        openModalId: null,
        chart: null
    };

    const backdrop = document.getElementById('backdrop');
    const modals = {
        settings: document.getElementById('settings-modal'),
        operations: document.getElementById('operations-modal'),
        derivative: document.getElementById('derivative-modal'),
        createArray: document.getElementById('create-array-modal'),
        createMath: document.getElementById('create-math-modal'),
        error: document.getElementById('error-modal'),
        graph: document.getElementById('graph-modal'),
        integral: document.getElementById('integral-modal'),
        composite: document.getElementById('composite-modal'),
        auth: document.getElementById('auth-modal')
    };

    function openModal(id) {
        state.openModalId = id;
        backdrop.style.display = 'flex';
        Object.values(modals).forEach(m => m.style.display = 'none');
        modals[id].style.display = 'block';
    }

    function closeModal() {
        state.openModalId = null;
        backdrop.style.display = 'none';
        Object.values(modals).forEach(m => m.style.display = 'none');
    }

    document.querySelectorAll('[data-close]').forEach(btn => btn.addEventListener('click', closeModal));

    function showError(message) {
        document.getElementById('error-message').textContent = message || 'Неизвестная ошибка';
        openModal('error');
    }

    async function authFetch(url, options = {}) {
        const headers = options.headers || {};
        if (state.token) headers['Authorization'] = 'Bearer ' + state.token;
        options.headers = headers;
        const res = await fetch(url, options);
        if (res.status === 401) {
            localStorage.removeItem('token');
            localStorage.removeItem('login');
            localStorage.removeItem('role');
            state.token = null;
            state.login = null;
            state.role = null;
            updateUserChip();
            openModal('auth');
            throw new Error('Требуется авторизация');
        }
        return res;
    }

    async function apiCall(path, options = {}, expectBlob = false) {
        const res = await authFetch(`${apiBase}${path}`, options);
        if (!res.ok) {
            let message = 'Не удалось выполнить запрос';
            try {
                const body = await res.json();
                if (body && body.message) message = body.message;
            } catch (_) { /* ignore json parse errors */ }
            throw new Error(message);
        }
        return expectBlob ? res.blob() : res.json();
    }

    function updateUserChip(login = 'Гость', role) {
        const chip = document.getElementById('user-chip');
        chip.textContent = role ? `${login} (${role})` : login;
    }

    // Theme toggle
    document.getElementById('toggle-theme').addEventListener('click', () => {
        document.body.classList.toggle('dark');
    });

    // Auth logic
    document.getElementById('auth-switch').addEventListener('click', () => {
        state.authMode = state.authMode === 'login' ? 'register' : 'login';
        document.getElementById('auth-title').textContent = state.authMode === 'login' ? 'Вход' : 'Регистрация';
    });

    document.getElementById('auth-submit').addEventListener('click', async () => {
        try {
            const login = document.getElementById('auth-login').value;
            const password = document.getElementById('auth-password').value;
            const endpoint = state.authMode === 'login' ? '/auth/login' : '/auth/register';
            const data = await apiCall(endpoint, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ login, password }) });
            state.token = data.token;
            state.login = data.login;
            state.role = data.role;
            localStorage.setItem('token', state.token);
            localStorage.setItem('login', data.login);
            localStorage.setItem('role', data.role);
            updateUserChip(data.login, data.role);
            await hydrateAfterAuth();
            closeModal();
        } catch (err) {
            showError(err.message);
        }
    });

    if (!state.token) {
        openModal('auth');
    }

    // Factory load/save
    async function loadFactory() {
        const data = await apiCall('/settings/factory');
        state.factory = data.type;
        document.getElementById('factory-select').value = data.type;
    }

    async function saveFactory() {
        try {
            const type = document.getElementById('factory-select').value;
            await apiCall('/settings/factory', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ type })});
            state.factory = type;
            state.saveFormat = document.getElementById('save-format').value;
            closeModal();
        } catch (err) {
            showError(err.message);
        }
    }

    // Functions list
    async function loadFunctionsList() {
        const names = await apiCall('/functions');
        state.functionsList = names;
        const select = document.getElementById('math-function');
        select.innerHTML = '';
        names.forEach(name => {
            const option = document.createElement('option');
            option.value = name; option.textContent = name; select.appendChild(option);
        });
        renderCompositeList();
    }

    async function loadSavedFunctions() {
        const list = await apiCall('/user-functions');
        state.savedFunctions = list;
        const select = document.getElementById('graph-saved');
        select.innerHTML = '';
        if (list.length === 0) {
            const option = document.createElement('option');
            option.disabled = true;
            option.selected = true;
            option.textContent = 'Нет сохранённых графиков';
            select.appendChild(option);
            return;
        }
        list.forEach(fn => {
            const option = document.createElement('option');
            option.value = fn.id;
            option.textContent = fn.name;
            select.appendChild(option);
        });
    }

    function renderCompositeList() {
        const container = document.getElementById('composite-list');
        container.innerHTML = '';
        state.functionsList.forEach(name => {
            const row = document.createElement('div');
            row.className = 'row';
            const input = document.createElement('input');
            input.type = 'checkbox';
            input.value = name;
            row.appendChild(input);
            const label = document.createElement('span');
            label.textContent = name;
            row.appendChild(label);
            container.appendChild(row);
        });
    }

    // Table rendering
    function renderTable(target, elementId, editableY) {
        const wrapper = document.getElementById(elementId);
        wrapper.innerHTML = '';
        const fn = state.functions[target];
        if (!fn || !fn.points || fn.points.length === 0) {
            wrapper.innerHTML = '<div class="hint" style="padding:12px;">Функция не задана</div>';
            return;
        }
        const table = document.createElement('table');
        const head = document.createElement('tr');
        head.innerHTML = '<th>X</th><th>Y</th>';
        table.appendChild(head);
        fn.points.forEach((pt, idx) => {
            const row = document.createElement('tr');
            const xCell = document.createElement('td');
            xCell.textContent = pt.x;
            const yCell = document.createElement('td');
            if (editableY) {
                const input = document.createElement('input');
                input.type = 'number';
                input.value = pt.y;
                input.addEventListener('input', (e) => {
                    state.functions[target].points[idx].y = parseFloat(e.target.value);
                });
                yCell.appendChild(input);
            } else {
                yCell.textContent = pt.y;
            }
            row.appendChild(xCell);
            row.appendChild(yCell);
            table.appendChild(row);
        });
        wrapper.appendChild(table);
    }

    function renderAllTables() {
        renderTable('opA', 'table-a', true);
        renderTable('opB', 'table-b', true);
        renderTable('result', 'table-result', false);
        renderTable('diffSource', 'table-derivative-src', true);
        renderTable('diffResult', 'table-derivative-res', false);
        renderTable('graph', 'table-graph', true);
        renderTable('integral', 'table-integral', true);
        redrawChart();
    }

    function prepareCreate(target, mode) {
        state.creationTarget = target;
        if (mode === 'array') {
            openModal('createArray');
        } else {
            openModal('createMath');
        }
    }

    // UI bindings
    document.getElementById('open-settings').addEventListener('click', () => openModal('settings'));
    document.getElementById('open-operations').addEventListener('click', () => openModal('operations'));
    document.getElementById('open-derivative').addEventListener('click', () => openModal('derivative'));
    document.getElementById('open-graph').addEventListener('click', () => { openModal('graph'); redrawChart(); });
    document.getElementById('open-integral').addEventListener('click', () => openModal('integral'));
    document.getElementById('open-composite').addEventListener('click', () => openModal('composite'));
    document.getElementById('save-factory').addEventListener('click', saveFactory);

    document.querySelectorAll('[data-create-array]').forEach(btn => {
        btn.addEventListener('click', () => prepareCreate(btn.dataset.createArray, 'array'));
    });
    document.querySelectorAll('[data-create-math]').forEach(btn => {
        btn.addEventListener('click', () => prepareCreate(btn.dataset.createMath, 'math'));
    });

    document.getElementById('array-generate').addEventListener('click', () => {
        const count = Number(document.getElementById('array-count').value);
        if (!Number.isInteger(count) || count < 2) { showError('Введите целое число точек не меньше 2'); return; }
        if (count > 500) { showError('Максимум 500 точек'); return; }
        const wrapper = document.getElementById('array-table-wrapper');
        wrapper.innerHTML = '';
        const table = document.createElement('table');
        const head = document.createElement('tr');
        head.innerHTML = '<th>X</th><th>Y</th>';
        table.appendChild(head);
        for (let i = 0; i < count; i++) {
            const row = document.createElement('tr');
            row.innerHTML = `<td><input type="number" step="0.1" class="x-input" placeholder="X${i+1}"></td><td><input type="number" step="0.1" class="y-input" placeholder="Y${i+1}"></td>`;
            table.appendChild(row);
        }
        wrapper.appendChild(table);
    });

    document.getElementById('array-submit').addEventListener('click', async () => {
        const xInputs = Array.from(document.querySelectorAll('#array-table-wrapper .x-input'));
        const yInputs = Array.from(document.querySelectorAll('#array-table-wrapper .y-input'));
        if (xInputs.length === 0) { showError('Сначала создайте таблицу точек'); return; }
        const xValues = xInputs.map(el => parseFloat(el.value));
        const yValues = yInputs.map(el => parseFloat(el.value));
        if (xValues.some(v => Number.isNaN(v)) || yValues.some(v => Number.isNaN(v))) { showError('Заполните все значения X и Y'); return; }
        try {
            const points = await apiCall('/tabulated/array', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ xValues, yValues })});
            state.functions[state.creationTarget] = { ...state.functions[state.creationTarget], points };
            renderAllTables();
            closeModal();
        } catch (err) { showError(err.message); }
    });

    document.getElementById('math-submit').addEventListener('click', async () => {
        const functionName = document.getElementById('math-function').value;
        const from = document.getElementById('math-from').value;
        const to = document.getElementById('math-to').value;
        const count = Number(document.getElementById('math-count').value);
        try {
            const points = await apiCall('/tabulated/math', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ functionName, from, to, count })});
            state.functions[state.creationTarget] = { ...state.functions[state.creationTarget], points };
            renderAllTables();
            closeModal();
        } catch (err) { showError(err.message); }
    });

    async function performOperation(op) {
        try {
            const body = { operation: op, first: state.functions.opA.points, second: state.functions.opB.points };
            state.functions.result.points = await apiCall('/operations', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
            renderAllTables();
        } catch (e) { showError(e.message); }
    }

    document.querySelectorAll('[data-operation]').forEach(btn => btn.addEventListener('click', () => performOperation(btn.dataset.operation)));

    document.getElementById('run-derivative').addEventListener('click', async () => {
        try {
            state.functions.diffResult.points = await apiCall('/operations/derivative', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ function: state.functions.diffSource.points })});
            renderAllTables();
        } catch (e) { showError(e.message); }
    });

    // Insert/remove buttons
    document.querySelectorAll('[data-insert]').forEach(btn => {
        btn.addEventListener('click', () => {
            const target = btn.dataset.insert;
            const fn = state.functions[target];
            if (!fn.insertable) return;
            const x = parseFloat(prompt('Введите X новой точки')); if (Number.isNaN(x)) return;
            const y = parseFloat(prompt('Введите Y новой точки')); if (Number.isNaN(y)) return;
            fn.points = fn.points || [];
            fn.points.push({ x, y });
            fn.points.sort((a,b) => a.x - b.x);
            renderAllTables();
        });
    });
    document.querySelectorAll('[data-remove]').forEach(btn => {
        btn.addEventListener('click', () => {
            const target = btn.dataset.remove;
            const fn = state.functions[target];
            if (!fn.removable || !fn.points || fn.points.length === 0) return;
            const idx = parseInt(prompt('Введите индекс строки для удаления (начиная с 0)')); if (Number.isNaN(idx)) return;
            if (idx >= 0 && idx < fn.points.length) { fn.points.splice(idx,1); renderAllTables(); }
        });
    });

    // File actions
    function attachLoaders() {
        document.querySelectorAll('[data-load]').forEach(btn => {
            btn.addEventListener('click', () => {
                const target = btn.dataset.load;
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.bin,.dat,.ser,.json,.xml';
                input.onchange = async () => {
                    if (!input.files.length) return;
                    const form = new FormData();
                    form.append('file', input.files[0]);
                    try {
                        state.functions[target].points = await apiCall('/function-files/upload', { method:'POST', body: form });
                        renderAllTables();
                    } catch (err) { showError(err.message); }
                };
                input.click();
            });
        });
    }

    function attachSavers() {
        document.querySelectorAll('[data-save]').forEach(btn => {
            btn.addEventListener('click', async () => {
                const target = btn.dataset.save;
                const fn = state.functions[target];
                if (!fn || !fn.points || fn.points.length === 0) { showError('Функция не задана'); return; }
                const format = state.saveFormat;
                try {
                    const blob = await apiCall('/function-files/download', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ function: fn.points, format })}, true);
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = `tabulated-function.${format === 'bin' ? 'bin' : format}`; a.click();
                    window.URL.revokeObjectURL(url);
                } catch (err) { showError(err.message); }
            });
        });
    }

    // Apply
    document.getElementById('apply-run').addEventListener('click', async () => {
        const x = parseFloat(document.getElementById('apply-x').value);
        if (Number.isNaN(x)) { showError('Введите корректный X'); return; }
        try {
            const val = await apiCall('/operations/apply', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ function: state.functions.graph.points, x })});
            document.getElementById('apply-result').textContent = val;
        } catch (err) { showError(err.message); }
    });

    document.getElementById('graph-save').addEventListener('click', async () => {
        const name = document.getElementById('graph-name').value.trim();
        const points = state.functions.graph.points || [];
        if (!name) { showError('Укажите имя функции перед сохранением'); return; }
        if (!points.length) { showError('Добавьте точки перед сохранением'); return; }
        try {
            const saved = await apiCall('/user-functions', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name, points })});
            state.savedFunctions.push(saved);
            await loadSavedFunctions();
            document.getElementById('graph-name').value = '';
        } catch (err) { showError(err.message); }
    });

    document.getElementById('graph-load').addEventListener('click', () => {
        const select = document.getElementById('graph-saved');
        const id = select.value;
        const fn = state.savedFunctions.find(f => String(f.id) === String(id));
        if (!fn) { showError('Выберите сохранённую функцию'); return; }
        state.functions.graph.points = fn.points;
        renderAllTables();
    });

    // Integral
    document.getElementById('integral-run').addEventListener('click', async () => {
        const threads = Number(document.getElementById('integral-threads').value);
        try {
            const val = await apiCall('/operations/integral', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ function: state.functions.integral.points, threads })});
            document.getElementById('integral-result').textContent = val;
        } catch (err) { showError(err.message); }
    });

    // Composite creation
    document.getElementById('composite-save').addEventListener('click', async () => {
        const name = document.getElementById('composite-name').value;
        const priority = parseInt(document.getElementById('composite-priority').value) || 5;
        const components = Array.from(document.querySelectorAll('#composite-list input[type="checkbox"]:checked')).map(c => c.value);
        if (components.length === 0) { showError('Выберите хотя бы одну функцию'); return; }
        try {
            state.functionsList = await apiCall('/functions/composite', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name, priority, components })});
            await loadFunctionsList();
            closeModal();
        } catch (err) { showError(err.message); }
    });

    // Chart
    function redrawChart() {
        const ctx = document.getElementById('graph-canvas');
        if (!ctx) return;
        const pts = (state.functions.graph.points || []).slice().sort((a,b) => a.x - b.x);
        const labels = pts.map(p => p.x);
        const data = pts.map(p => p.y);
        if (state.chart) state.chart.destroy();
        state.chart = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets: [{ label: 'f(x)', data, borderColor: '#2d6cdf', backgroundColor: 'rgba(45,108,223,0.2)', fill: true, tension: 0.3 }] },
            options: { responsive: true, plugins: { legend: { display: false } }, scales: { x: { title: { display: true, text: 'x' } }, y: { title: { display: true, text: 'y' } } } }
        });
    }

    // Init
    async function hydrateAfterAuth() {
        await loadFactory();
        await loadFunctionsList();
        await loadSavedFunctions();
        renderAllTables();
        attachLoaders();
        attachSavers();
    }

    document.addEventListener('DOMContentLoaded', async () => {
        if (state.token) {
            try {
                updateUserChip(state.login || 'Пользователь', state.role);
                await hydrateAfterAuth();
            } catch (err) {
                showError(err.message);
                openModal('auth');
            }
        } else {
            openModal('auth');
        }
    });
</script>
</body>
</html>
