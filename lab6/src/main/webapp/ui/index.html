<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Табулированные функции</title>
    <style>
        :root {
            --bg: #f5f7fb;
            --card: #ffffff;
            --primary: #2d6cdf;
            --primary-dark: #1f4ea3;
            --muted: #5f6b7c;
            --border: #dfe3ea;
            --danger: #e74c3c;
        }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: "Inter", Arial, sans-serif; background: var(--bg); color: #1f2d3d; }
        header { padding: 24px; background: var(--card); border-bottom: 1px solid var(--border); }
        header h1 { margin: 0 0 6px; }
        header p { margin: 0; color: var(--muted); }
        main { padding: 24px; display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.04); }
        .card h2 { margin-top: 0; margin-bottom: 8px; }
        .card p { color: var(--muted); margin-top: 0; }
        button { background: var(--primary); border: none; color: #fff; padding: 10px 16px; border-radius: 10px; cursor: pointer; font-weight: 600; transition: background 0.2s ease; }
        button:hover { background: var(--primary-dark); }
        button.secondary { background: #ecf1f9; color: #1f2d3d; border: 1px solid var(--border); }
        button.secondary:hover { background: #e1e8f3; }
        button.danger { background: var(--danger); }
        .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .hint { color: var(--muted); font-size: 13px; margin-top: 4px; }
        .table-wrapper { border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px 10px; border-bottom: 1px solid var(--border); }
        th { background: #f1f4fa; text-align: left; font-weight: 600; font-size: 14px; }
        td input { width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 8px; }
        .actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
        .modal-backdrop { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.45); display: none; align-items: center; justify-content: center; padding: 16px; z-index: 10; }
        .modal { background: #fff; border-radius: 16px; width: min(960px, 95vw); max-height: 90vh; overflow: auto; padding: 20px; box-shadow: 0 18px 40px rgba(0,0,0,0.16); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; gap: 12px; }
        .modal-header h3 { margin: 0; }
        .close-btn { background: transparent; border: none; font-size: 20px; color: var(--muted); cursor: pointer; }
        label { font-weight: 600; color: #1f2d3d; }
        input, select { padding: 10px 12px; border: 1px solid var(--border); border-radius: 10px; background: #fff; }
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; }
        .divider { height: 1px; background: var(--border); margin: 14px 0; }
    </style>
</head>
<body>
<header>
    <h1>Работа с табулированными функциями</h1>
    <p>Главное окно: открывайте настройки и операции без дублирования окон</p>
</header>
<main>
    <div class="card">
        <h2>Настройки</h2>
        <p>Выбор фабрики табулированных функций (по умолчанию — массив)</p>
        <button id="open-settings">Открыть настройки</button>
    </div>
    <div class="card">
        <h2>Операции над функциями</h2>
        <p>Сложение, вычитание, умножение и деление двух функций</p>
        <button id="open-operations">Открыть окно операций</button>
    </div>
    <div class="card">
        <h2>Дифференцирование</h2>
        <p>Получение производной табулированной функции</p>
        <button id="open-derivative">Открыть окно дифференцирования</button>
    </div>
</main>

<div class="modal-backdrop" id="backdrop">
    <div class="modal" id="settings-modal">
        <div class="modal-header"><h3>Настройки фабрики</h3><button class="close-btn" data-close>&times;</button></div>
        <div class="divider"></div>
        <div class="grid-2">
            <label for="factory-select">Текущая фабрика</label>
            <select id="factory-select">
                <option value="ARRAY">Массив</option>
                <option value="LIST">Связный список</option>
            </select>
        </div>
        <div class="actions" style="margin-top:14px; justify-content: flex-end;">
            <button class="secondary" data-close>Отмена</button>
            <button id="save-factory">Сохранить</button>
        </div>
    </div>

    <div class="modal" id="operations-modal">
        <div class="modal-header"><h3>Базовые операции</h3><button class="close-btn" data-close>&times;</button></div>
        <p class="hint">Создавайте функции из массивов или из другой функции, загружайте/сохраняйте и редактируйте значения Y</p>
        <div class="grid-2">
            <div>
                <h4>Первый операнд</h4>
                <div id="table-a" class="table-wrapper"></div>
                <div class="actions">
                    <button data-create-array="opA">Создать из массивов</button>
                    <button data-create-math="opA" class="secondary">Создать из функции</button>
                    <button data-load="opA" class="secondary">Загрузить</button>
                    <button data-save="opA" class="secondary">Сохранить</button>
                </div>
            </div>
            <div>
                <h4>Второй операнд</h4>
                <div id="table-b" class="table-wrapper"></div>
                <div class="actions">
                    <button data-create-array="opB">Создать из массивов</button>
                    <button data-create-math="opB" class="secondary">Создать из функции</button>
                    <button data-load="opB" class="secondary">Загрузить</button>
                    <button data-save="opB" class="secondary">Сохранить</button>
                </div>
            </div>
        </div>
        <div class="divider"></div>
        <h4>Результат</h4>
        <div id="table-result" class="table-wrapper"></div>
        <div class="actions">
            <button data-operation="add">Сложение</button>
            <button data-operation="subtract" class="secondary">Вычитание</button>
            <button data-operation="multiply" class="secondary">Умножение</button>
            <button data-operation="divide" class="secondary">Деление</button>
            <button data-save="result" class="secondary">Сохранить результат</button>
        </div>
    </div>

    <div class="modal" id="derivative-modal">
        <div class="modal-header"><h3>Дифференцирование функции</h3><button class="close-btn" data-close>&times;</button></div>
        <p class="hint">Левая таблица редактируется, правая — результат вычисления производной.</p>
        <div class="grid-2">
            <div>
                <h4>Исходная функция</h4>
                <div id="table-derivative-src" class="table-wrapper"></div>
                <div class="actions">
                    <button data-create-array="diffSource">Создать из массивов</button>
                    <button data-create-math="diffSource" class="secondary">Создать из функции</button>
                    <button data-load="diffSource" class="secondary">Загрузить</button>
                    <button data-save="diffSource" class="secondary">Сохранить</button>
                </div>
            </div>
            <div>
                <h4>Производная</h4>
                <div id="table-derivative-res" class="table-wrapper"></div>
                <div class="actions">
                    <button id="run-derivative">Вычислить производную</button>
                    <button data-save="diffResult" class="secondary">Сохранить результат</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="create-array-modal">
        <div class="modal-header"><h3>Создание функции из массивов</h3><button class="close-btn" data-close>&times;</button></div>
        <div class="row" style="margin: 10px 0;">
            <label for="array-count">Количество точек</label>
            <input id="array-count" type="number" min="2" max="500" placeholder="Например, 5">
            <button id="array-generate">Построить таблицу</button>
        </div>
        <div class="hint">Повторное нажатие сбрасывает данные. Максимум 500 точек.</div>
        <div id="array-table-wrapper" class="table-wrapper" style="margin-top:10px;"></div>
        <div class="actions" style="justify-content: flex-end;">
            <button class="secondary" data-close>Отмена</button>
            <button id="array-submit">Создать</button>
        </div>
    </div>

    <div class="modal" id="create-math-modal">
        <div class="modal-header"><h3>Создание из другой функции</h3><button class="close-btn" data-close>&times;</button></div>
        <div class="grid-2" style="margin-top:10px;">
            <label for="math-function">Функция</label>
            <select id="math-function"></select>
            <label for="math-from">От</label>
            <input id="math-from" type="number" step="0.1" placeholder="0">
            <label for="math-to">До</label>
            <input id="math-to" type="number" step="0.1" placeholder="10">
            <label for="math-count">Количество точек</label>
            <input id="math-count" type="number" min="2" max="500" value="5">
        </div>
        <div class="actions" style="justify-content: flex-end; margin-top:14px;">
            <button class="secondary" data-close>Отмена</button>
            <button id="math-submit">Создать</button>
        </div>
    </div>

    <div class="modal" id="error-modal">
        <div class="modal-header"><h3>Ошибка</h3><button class="close-btn" data-close>&times;</button></div>
        <p id="error-message"></p>
        <div class="actions" style="justify-content: flex-end;">
            <button data-close>Закрыть</button>
        </div>
    </div>
</div>

<script>
    const state = {
        factory: 'ARRAY',
        functions: {
            opA: [], opB: [], result: [], diffSource: [], diffResult: []
        },
        creationTarget: null,
        openModalId: null
    };

    const backdrop = document.getElementById('backdrop');
    const modals = {
        settings: document.getElementById('settings-modal'),
        operations: document.getElementById('operations-modal'),
        derivative: document.getElementById('derivative-modal'),
        createArray: document.getElementById('create-array-modal'),
        createMath: document.getElementById('create-math-modal'),
        error: document.getElementById('error-modal')
    };

    function openModal(id) {
        state.openModalId = id;
        backdrop.style.display = 'flex';
        Object.values(modals).forEach(m => m.style.display = 'none');
        modals[id].style.display = 'block';
    }

    function closeModal() {
        state.openModalId = null;
        backdrop.style.display = 'none';
        Object.values(modals).forEach(m => m.style.display = 'none');
    }

    document.querySelectorAll('[data-close]').forEach(btn => btn.addEventListener('click', closeModal));

    function showError(message) {
        document.getElementById('error-message').textContent = message || 'Неизвестная ошибка';
        openModal('error');
    }

    async function loadFactory() {
        const res = await fetch('/ui/api/settings/factory');
        const data = await res.json();
        state.factory = data.type;
        document.getElementById('factory-select').value = data.type;
    }

    async function saveFactory() {
        const type = document.getElementById('factory-select').value;
        const res = await fetch('/ui/api/settings/factory', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ type })});
        if (!res.ok) { showError('Не удалось сохранить фабрику'); return; }
        state.factory = type;
        closeModal();
    }

    async function loadFunctionsList() {
        const res = await fetch('/ui/api/functions');
        if (!res.ok) { showError('Не удалось загрузить список функций'); return; }
        const names = await res.json();
        const select = document.getElementById('math-function');
        select.innerHTML = '';
        names.forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            select.appendChild(option);
        });
    }

    function renderTable(target, elementId, editableY) {
        const wrapper = document.getElementById(elementId);
        wrapper.innerHTML = '';
        const points = state.functions[target];
        if (!points || points.length === 0) {
            wrapper.innerHTML = '<div class="hint" style="padding:12px;">Функция не задана</div>';
            return;
        }
        const table = document.createElement('table');
        const head = document.createElement('tr');
        head.innerHTML = '<th>X</th><th>Y</th>';
        table.appendChild(head);
        points.forEach((pt, idx) => {
            const row = document.createElement('tr');
            const xCell = document.createElement('td');
            xCell.textContent = pt.x;
            const yCell = document.createElement('td');
            if (editableY) {
                const input = document.createElement('input');
                input.type = 'number';
                input.value = pt.y;
                input.addEventListener('input', (e) => {
                    state.functions[target][idx].y = parseFloat(e.target.value);
                });
                yCell.appendChild(input);
            } else {
                yCell.textContent = pt.y;
            }
            row.appendChild(xCell);
            row.appendChild(yCell);
            table.appendChild(row);
        });
        wrapper.appendChild(table);
    }

    function renderAllTables() {
        renderTable('opA', 'table-a', true);
        renderTable('opB', 'table-b', true);
        renderTable('result', 'table-result', false);
        renderTable('diffSource', 'table-derivative-src', true);
        renderTable('diffResult', 'table-derivative-res', false);
    }

    function prepareCreate(target, mode) {
        state.creationTarget = target;
        if (mode === 'array') {
            openModal('createArray');
        } else {
            openModal('createMath');
        }
    }

    document.getElementById('open-settings').addEventListener('click', () => openModal('settings'));
    document.getElementById('open-operations').addEventListener('click', () => openModal('operations'));
    document.getElementById('open-derivative').addEventListener('click', () => openModal('derivative'));
    document.getElementById('save-factory').addEventListener('click', saveFactory);

    document.querySelectorAll('[data-create-array]').forEach(btn => {
        btn.addEventListener('click', () => prepareCreate(btn.dataset.createArray, 'array'));
    });
    document.querySelectorAll('[data-create-math]').forEach(btn => {
        btn.addEventListener('click', () => prepareCreate(btn.dataset.createMath, 'math'));
    });

    document.getElementById('array-generate').addEventListener('click', () => {
        const count = Number(document.getElementById('array-count').value);
        if (!Number.isInteger(count) || count < 2) { showError('Введите целое число точек не меньше 2'); return; }
        if (count > 500) { showError('Максимум 500 точек'); return; }
        const wrapper = document.getElementById('array-table-wrapper');
        wrapper.innerHTML = '';
        const table = document.createElement('table');
        const head = document.createElement('tr');
        head.innerHTML = '<th>X</th><th>Y</th>';
        table.appendChild(head);
        for (let i = 0; i < count; i++) {
            const row = document.createElement('tr');
            const xCell = document.createElement('td');
            const yCell = document.createElement('td');
            xCell.innerHTML = `<input type="number" step="0.1" class="x-input" placeholder="X${i+1}">`;
            yCell.innerHTML = `<input type="number" step="0.1" class="y-input" placeholder="Y${i+1}">`;
            row.appendChild(xCell); row.appendChild(yCell); table.appendChild(row);
        }
        wrapper.appendChild(table);
    });

    document.getElementById('array-submit').addEventListener('click', async () => {
        const xInputs = Array.from(document.querySelectorAll('#array-table-wrapper .x-input'));
        const yInputs = Array.from(document.querySelectorAll('#array-table-wrapper .y-input'));
        if (xInputs.length === 0) { showError('Сначала создайте таблицу точек'); return; }
        const xValues = xInputs.map(el => parseFloat(el.value));
        const yValues = yInputs.map(el => parseFloat(el.value));
        if (xValues.some(v => Number.isNaN(v)) || yValues.some(v => Number.isNaN(v))) { showError('Заполните все значения X и Y'); return; }
        const res = await fetch('/ui/api/tabulated/array', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ xValues, yValues })});
        if (!res.ok) { const err = await res.json(); showError(err.message); return; }
        const points = await res.json();
        state.functions[state.creationTarget] = points;
        renderAllTables();
        closeModal();
    });

    document.getElementById('math-submit').addEventListener('click', async () => {
        const functionName = document.getElementById('math-function').value;
        const from = document.getElementById('math-from').value;
        const to = document.getElementById('math-to').value;
        const count = Number(document.getElementById('math-count').value);
        const res = await fetch('/ui/api/tabulated/math', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ functionName, from, to, count })});
        if (!res.ok) { const err = await res.json(); showError(err.message); return; }
        const points = await res.json();
        state.functions[state.creationTarget] = points;
        renderAllTables();
        closeModal();
    });

    async function performOperation(op) {
        try {
            const body = { operation: op, first: state.functions.opA, second: state.functions.opB };
            const res = await fetch('/ui/api/operations', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
            if (!res.ok) { const err = await res.json(); showError(err.message); return; }
            state.functions.result = await res.json();
            renderAllTables();
        } catch (e) { showError(e.message); }
    }

    document.querySelectorAll('[data-operation]').forEach(btn => btn.addEventListener('click', () => performOperation(btn.dataset.operation)));

    document.getElementById('run-derivative').addEventListener('click', async () => {
        try {
            const res = await fetch('/ui/api/operations/derivative', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ function: state.functions.diffSource })});
            if (!res.ok) { const err = await res.json(); showError(err.message); return; }
            state.functions.diffResult = await res.json();
            renderAllTables();
        } catch (e) { showError(e.message); }
    });

    function attachLoaders() {
        document.querySelectorAll('[data-load]').forEach(btn => {
            btn.addEventListener('click', () => {
                const target = btn.dataset.load;
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.bin,.dat,.ser';
                input.onchange = async () => {
                    if (!input.files.length) return;
                    const form = new FormData();
                    form.append('file', input.files[0]);
                    const res = await fetch('/ui/api/function-files/upload', { method:'POST', body: form });
                    if (!res.ok) { const err = await res.json(); showError(err.message); return; }
                    state.functions[target] = await res.json();
                    renderAllTables();
                };
                input.click();
            });
        });
    }

    function attachSavers() {
        document.querySelectorAll('[data-save]').forEach(btn => {
            btn.addEventListener('click', async () => {
                const target = btn.dataset.save;
                const fn = state.functions[target];
                if (!fn || fn.length === 0) { showError('Функция не задана'); return; }
                const res = await fetch('/ui/api/function-files/download', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ function: fn })});
                if (!res.ok) { const err = await res.json(); showError(err.message); return; }
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'tabulated-function.bin'; a.click();
                window.URL.revokeObjectURL(url);
            });
        });
    }

    document.addEventListener('DOMContentLoaded', async () => {
        await loadFactory();
        await loadFunctionsList();
        renderAllTables();
        attachLoaders();
        attachSavers();
    });
</script>
</body>
</html>
