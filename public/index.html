<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Аккаунт | Вход и регистрация</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --accent: #6366f1;
      --accent-strong: #4f46e5;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --error: #f87171;
      --success: #34d399;
      --border: #1f2937;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(99,102,241,0.12), transparent 30%),
                  radial-gradient(circle at 80% 0%, rgba(52,211,153,0.15), transparent 28%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .shell {
      width: min(960px, 100%);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
      align-items: stretch;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: 0 30px 120px rgba(0,0,0,0.35);
      overflow: hidden;
      position: relative;
    }

    .card-header {
      padding: 20px 24px 12px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .tabs {
      display: inline-flex;
      background: #0b1220;
      padding: 4px;
      border-radius: 12px;
      border: 1px solid var(--border);
      gap: 4px;
    }

    .tab {
      border: none;
      background: transparent;
      color: var(--muted);
      padding: 8px 14px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.18s ease;
      font-weight: 600;
    }

    .tab.active {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 8px 24px rgba(99,102,241,0.35);
    }

    .card-body {
      padding: 22px 24px 26px;
    }

    form {
      display: grid;
      gap: 14px;
      transition: opacity 0.25s ease, transform 0.25s ease;
    }

    form.hidden {
      pointer-events: none;
      opacity: 0;
      transform: translateY(10px);
      position: absolute;
      inset: 0;
    }

    label {
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 6px;
      display: block;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    input {
      width: 100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #0b1220;
      color: var(--text);
      transition: border-color 0.18s ease, box-shadow 0.18s ease;
      font-size: 15px;
    }

    input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(99,102,241,0.22);
    }

    input.invalid {
      border-color: var(--error);
      box-shadow: 0 0 0 3px rgba(248,113,113,0.22);
    }

    .error-text, .success-text {
      font-size: 13px;
      line-height: 1.4;
      opacity: 0;
      transform: translateY(-4px);
      transition: opacity 0.2s ease, transform 0.2s ease;
      min-height: 18px;
    }

    .error-text.show { opacity: 1; transform: translateY(0); color: var(--error); }
    .success-text.show { opacity: 1; transform: translateY(0); color: var(--success); }

    .actions {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    button.primary, button.secondary, button.ghost {
      border: none;
      cursor: pointer;
      padding: 12px 14px;
      border-radius: 12px;
      font-weight: 700;
      transition: transform 0.18s ease, box-shadow 0.2s ease, background 0.2s;
    }

    button.primary {
      background: linear-gradient(120deg, var(--accent), var(--accent-strong));
      color: white;
      box-shadow: 0 14px 34px rgba(79,70,229,0.35);
      min-width: 160px;
    }

    button.primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
    }

    button.secondary {
      background: #0b1220;
      color: var(--text);
      border: 1px solid var(--border);
    }

    button.ghost {
      background: transparent;
      color: var(--muted);
      text-decoration: underline;
      padding: 0;
    }

    button.loading {
      position: relative;
      color: transparent !important;
    }

    button.loading::after {
      content: '';
      position: absolute;
      inset: 50% auto auto 50%;
      width: 18px;
      height: 18px;
      margin: -9px 0 0 -9px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.55);
      border-top-color: white;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .switcher {
      margin-top: 14px;
      color: var(--muted);
      font-size: 14px;
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .banner {
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #0b1220;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .badge { padding: 4px 8px; border-radius: 10px; font-weight: 700; font-size: 12px; }
    .badge.success { background: rgba(52,211,153,0.15); color: var(--success); }
    .badge.warn { background: rgba(248,113,113,0.15); color: var(--error); }

    .ghost-link { color: var(--accent); cursor: pointer; text-decoration: none; }
    .ghost-link:hover { text-decoration: underline; }

    .helper-row { display: flex; align-items: center; gap: 10px; justify-content: space-between; flex-wrap: wrap; }
  </style>
</head>
<body>
  <div class="shell">
    <div class="card">
      <div class="card-header">
        <div>
          <div style="font-weight: 800; font-size: 20px;">Ваш аккаунт</div>
          <div style="color: var(--muted); font-size: 14px;">Войдите или создайте новый профиль</div>
        </div>
        <div class="tabs" role="tablist">
          <button class="tab active" data-mode="login" aria-selected="true">Вход</button>
          <button class="tab" data-mode="register" aria-selected="false">Регистрация</button>
        </div>
      </div>
      <div class="card-body" style="position: relative; min-height: 420px;">
        <form id="loginForm" novalidate>
          <div class="field">
            <label for="loginEmail">Email или логин</label>
            <input type="text" id="loginEmail" name="email" autocomplete="username" placeholder="you@mail.ru" />
            <div class="error-text" data-error-for="loginEmail"></div>
          </div>
          <div class="field">
            <label for="loginPassword">Пароль</label>
            <input type="password" id="loginPassword" name="password" autocomplete="current-password" placeholder="••••••••" />
            <div class="error-text" data-error-for="loginPassword"></div>
          </div>
          <div class="helper-row">
            <button type="button" class="secondary" id="loginFillDemo">Заполнить тестовые данные</button>
            <span class="success-text" id="loginSuccess"></span>
          </div>
          <div class="actions">
            <button class="primary" id="loginSubmit" type="submit">Войти</button>
            <div class="error-text" id="loginFormError"></div>
          </div>
        </form>

        <form id="registerForm" class="hidden" novalidate>
          <div class="field">
            <label for="regUsername">Имя</label>
            <input type="text" id="regUsername" name="username" autocomplete="nickname" placeholder="Иван" />
            <div class="error-text" data-error-for="regUsername"></div>
          </div>
          <div class="field">
            <label for="regEmail">Email</label>
            <input type="email" id="regEmail" name="email" autocomplete="email" placeholder="you@mail.ru" />
            <div class="error-text" data-error-for="regEmail"></div>
          </div>
          <div class="field">
            <label for="regPassword">Пароль</label>
            <input type="password" id="regPassword" name="password" autocomplete="new-password" placeholder="Не менее 6 символов" />
            <div class="error-text" data-error-for="regPassword"></div>
          </div>
          <div class="field">
            <label for="regConfirm">Подтверждение пароля</label>
            <input type="password" id="regConfirm" name="confirm" autocomplete="new-password" placeholder="Повторите пароль" />
            <div class="error-text" data-error-for="regConfirm"></div>
          </div>
          <div class="helper-row">
            <button type="button" class="secondary" id="registerFillDemo">Заполнить тестовые данные</button>
            <span class="success-text" id="registerSuccess"></span>
          </div>
          <div class="actions">
            <button class="primary" id="registerSubmit" type="submit">Зарегистрироваться</button>
            <div class="error-text" id="registerFormError"></div>
          </div>
        </form>
      </div>
      <div class="card-body" style="border-top: 1px solid var(--border); background: #0b1220;">
        <div class="switcher" id="switchHint">
          <span>Еще нет аккаунта?</span>
          <a class="ghost-link" href="#" id="switchToRegister">Зарегистрироваться</a>
        </div>
      </div>
    </div>

    <div class="banner">
      <div>
        <div style="font-weight: 700;">Статус сессии</div>
        <div id="sessionStatus">Пока не авторизованы.</div>
      </div>
      <div>
        <span class="badge" id="sessionBadge">Гость</span>
      </div>
    </div>
  </div>

  <script>
    const state = {
      mode: 'login',
      token: localStorage.getItem('auth_token') || '',
    };

    const forms = {
      login: document.getElementById('loginForm'),
      register: document.getElementById('registerForm'),
    };

    const tabs = Array.from(document.querySelectorAll('.tab'));
    const switchLink = document.getElementById('switchToRegister');
    const sessionStatus = document.getElementById('sessionStatus');
    const sessionBadge = document.getElementById('sessionBadge');
    const loginSuccess = document.getElementById('loginSuccess');
    const registerSuccess = document.getElementById('registerSuccess');

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    const withTimeout = (ms, promise) => {
      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), ms);
      return Promise.race([
        promise(controller.signal).finally(() => clearTimeout(timer)),
      ]);
    };

    function setMode(mode) {
      state.mode = mode;
      tabs.forEach((tab) => tab.classList.toggle('active', tab.dataset.mode === mode));
      forms.login.classList.toggle('hidden', mode !== 'login');
      forms.register.classList.toggle('hidden', mode !== 'register');
      document.getElementById('switchHint').innerHTML =
        mode === 'login'
          ? 'Еще нет аккаунта? <a class="ghost-link" href="#" id="switchToRegister">Зарегистрироваться</a>'
          : 'Уже есть аккаунт? <a class="ghost-link" href="#" id="switchToLogin">Войти</a>';
      attachSwitchHandlers();
      clearGlobalMessages();
      focusFirstField();
    }

    function focusFirstField() {
      const selector = state.mode === 'login' ? '#loginEmail' : '#regUsername';
      const el = document.querySelector(selector);
      if (el) el.focus();
    }

    function attachSwitchHandlers() {
      const toReg = document.getElementById('switchToRegister');
      const toLogin = document.getElementById('switchToLogin');
      if (toReg) toReg.addEventListener('click', (e) => { e.preventDefault(); setMode('register'); });
      if (toLogin) toLogin.addEventListener('click', (e) => { e.preventDefault(); setMode('login'); });
    }

    function setLoading(button, loading) {
      if (loading) {
        button.classList.add('loading');
        button.setAttribute('disabled', 'disabled');
      } else {
        button.classList.remove('loading');
        button.removeAttribute('disabled');
      }
    }

    function showFieldError(inputId, message) {
      const input = document.getElementById(inputId);
      const errorEl = document.querySelector(`[data-error-for="${inputId}"]`);
      if (!input || !errorEl) return;
      if (message) {
        input.classList.add('invalid');
        errorEl.textContent = message;
        errorEl.classList.add('show');
      } else {
        input.classList.remove('invalid');
        errorEl.textContent = '';
        errorEl.classList.remove('show');
      }
    }

    function setFormError(formId, message) {
      const errorEl = document.getElementById(formId);
      if (!errorEl) return;
      if (message) {
        errorEl.textContent = message;
        errorEl.classList.add('show');
      } else {
        errorEl.textContent = '';
        errorEl.classList.remove('show');
      }
    }

    function clearGlobalMessages() {
      loginSuccess.textContent = '';
      loginSuccess.classList.remove('show');
      registerSuccess.textContent = '';
      registerSuccess.classList.remove('show');
      setFormError('loginFormError', '');
      setFormError('registerFormError', '');
      ['loginEmail','loginPassword','regUsername','regEmail','regPassword','regConfirm'].forEach((id) => showFieldError(id, ''));
    }

    function validateLogin(values) {
      const errors = {};
      if (!values.email.trim()) errors.email = 'Введите email или логин';
      if (!values.password.trim()) errors.password = 'Введите пароль';
      return errors;
    }

    function validateRegister(values) {
      const errors = {};
      if (!values.username.trim()) errors.username = 'Введите имя';
      if (!values.email.trim()) errors.email = 'Введите email';
      else if (!emailRegex.test(values.email)) errors.email = 'Некорректный email';
      if (!values.password.trim()) errors.password = 'Введите пароль';
      else if (values.password.length < 6) errors.password = 'Пароль должен содержать минимум 6 символов';
      if (!values.confirm.trim()) errors.confirm = 'Подтвердите пароль';
      else if (values.confirm !== values.password) errors.confirm = 'Пароли не совпадают';
      return errors;
    }

    function renderErrors(errors, prefix) {
      const map = {
        email: `${prefix}Email`,
        password: `${prefix}Password`,
        username: 'regUsername',
        confirm: 'regConfirm',
      };
      Object.entries(map).forEach(([field, inputId]) => {
        showFieldError(inputId, errors[field] || '');
      });
    }

    async function handleRequest(path, payload) {
      try {
        return await withTimeout(10000, async (signal) => {
          const response = await fetch(path, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(payload),
            signal,
          });
          const data = await response.json().catch(() => ({ message: 'Сервер вернул некорректный ответ' }));
          return { ok: response.ok, status: response.status, data };
        });
      } catch (err) {
        if (err.name === 'AbortError') {
          return { ok: false, status: 0, data: { message: 'Сервер временно недоступен, попробуйте позже' } };
        }
        return { ok: false, status: 0, data: { message: 'Не удалось отправить запрос' } };
      }
    }

    function updateSessionBanner(authenticated, userEmail) {
      if (authenticated) {
        sessionStatus.textContent = userEmail ? `Вы вошли как ${userEmail}` : 'Вы авторизованы';
        sessionBadge.textContent = 'Онлайн';
        sessionBadge.className = 'badge success';
      } else {
        sessionStatus.textContent = 'Пока не авторизованы.';
        sessionBadge.textContent = 'Гость';
        sessionBadge.className = 'badge warn';
      }
    }

    function persistToken(token) {
      if (!token) return;
      state.token = token;
      localStorage.setItem('auth_token', token);
      updateSessionBanner(true);
    }

    function handleLoginSubmit(event) {
      event.preventDefault();
      clearGlobalMessages();
      const values = {
        email: document.getElementById('loginEmail').value,
        password: document.getElementById('loginPassword').value,
      };
      const errors = validateLogin(values);
      renderErrors(errors, 'login');
      if (Object.keys(errors).length) return;

      const submitBtn = document.getElementById('loginSubmit');
      setLoading(submitBtn, true);

      handleRequest('/api/auth/login', values).then(({ ok, data }) => {
        setLoading(submitBtn, false);
        if (!ok) {
          const message = data?.message || 'Неверный email или пароль';
          setFormError('loginFormError', message);
          if (Array.isArray(data?.errors)) {
            data.errors.forEach((err) => {
              const field = err.field === 'email' ? 'loginEmail' : 'loginPassword';
              showFieldError(field, err.message);
            });
          }
          return;
        }
        loginSuccess.textContent = 'Вход выполнен успешно!';
        loginSuccess.classList.add('show');
        persistToken(data.token);
        if (data?.user?.email) sessionStatus.textContent = `Вы вошли как ${data.user.email}`;
      });
    }

    function handleRegisterSubmit(event) {
      event.preventDefault();
      clearGlobalMessages();
      const values = {
        username: document.getElementById('regUsername').value,
        email: document.getElementById('regEmail').value,
        password: document.getElementById('regPassword').value,
        confirm: document.getElementById('regConfirm').value,
      };
      const errors = validateRegister(values);
      renderErrors(errors, 'reg');
      if (Object.keys(errors).length) return;

      const submitBtn = document.getElementById('registerSubmit');
      setLoading(submitBtn, true);

      handleRequest('/api/auth/register', values).then(({ ok, data }) => {
        setLoading(submitBtn, false);
        if (!ok) {
          const message = data?.message || 'Не удалось завершить регистрацию';
          setFormError('registerFormError', message);
          if (Array.isArray(data?.errors)) {
            data.errors.forEach((err) => {
              const fieldMap = { email: 'regEmail', password: 'regPassword', username: 'regUsername' };
              const fieldId = fieldMap[err.field];
              if (fieldId) showFieldError(fieldId, err.message);
            });
          }
          return;
        }
        registerSuccess.textContent = 'Регистрация успешна! Теперь вы можете войти';
        registerSuccess.classList.add('show');
        setTimeout(() => setMode('login'), 600);
      });
    }

    function attachValidation() {
      document.getElementById('loginEmail').addEventListener('input', () => {
        renderErrors(validateLogin({ email: document.getElementById('loginEmail').value, password: document.getElementById('loginPassword').value }), 'login');
      });
      document.getElementById('loginPassword').addEventListener('input', () => {
        renderErrors(validateLogin({ email: document.getElementById('loginEmail').value, password: document.getElementById('loginPassword').value }), 'login');
      });
      ['regUsername','regEmail','regPassword','regConfirm'].forEach((id) => {
        document.getElementById(id).addEventListener('input', () => {
          renderErrors(
            validateRegister({
              username: document.getElementById('regUsername').value,
              email: document.getElementById('regEmail').value,
              password: document.getElementById('regPassword').value,
              confirm: document.getElementById('regConfirm').value,
            }),
            'reg'
          );
        });
      });
    }

    function attachDemoFillers() {
      document.getElementById('loginFillDemo').addEventListener('click', () => {
        document.getElementById('loginEmail').value = 'user@mail.ru';
        document.getElementById('loginPassword').value = 'password123';
        renderErrors(validateLogin({ email: 'user@mail.ru', password: 'password123' }), 'login');
      });
      document.getElementById('registerFillDemo').addEventListener('click', () => {
        document.getElementById('regUsername').value = 'Макс (Общага)';
        document.getElementById('regEmail').value = 'user@mail.ru';
        document.getElementById('regPassword').value = 'password123';
        document.getElementById('regConfirm').value = 'password123';
        renderErrors(
          validateRegister({
            username: document.getElementById('regUsername').value,
            email: document.getElementById('regEmail').value,
            password: document.getElementById('regPassword').value,
            confirm: document.getElementById('regConfirm').value,
          }),
          'reg'
        );
      });
    }

    tabs.forEach((tab) => tab.addEventListener('click', () => setMode(tab.dataset.mode)));
    attachSwitchHandlers();
    attachValidation();
    attachDemoFillers();

    forms.login.addEventListener('submit', handleLoginSubmit);
    forms.register.addEventListener('submit', handleRegisterSubmit);

    updateSessionBanner(Boolean(state.token));
    focusFirstField();
  </script>
</body>
</html>
